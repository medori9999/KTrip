<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
    <title>K-Trip | Result</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="style.css">
    <style>
        /* Day íƒ­ ë””ìì¸ */
        .day-tab {
            padding: 8px 16px; border-radius: 20px; font-size: 13px; font-weight: 700;
            background-color: white; color: #6b7280; border: 1px solid #e5e7eb;
            cursor: pointer; transition: all 0.2s; white-space: nowrap;
        }
        .day-tab.active {
            background-color: #6366f1; color: white; border-color: #6366f1;
            box-shadow: 0 4px 6px -1px rgba(99, 102, 241, 0.3);
        }
        /* ìŠ¤í¬ë¡¤ë°” ìˆ¨ê¸°ê¸° */
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }

        /* Toast ì•Œë¦¼ ìŠ¤íƒ€ì¼ */
        .toast {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0.9);
            background: white;
            padding: 32px 40px;
            border-radius: 24px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            z-index: 1000;
            opacity: 0;
            transition: all 0.3s ease;
            max-width: 300px;
            text-align: center;
        }

        .toast.show {
            opacity: 1;
            transform: translate(-50%, -50%) scale(1);
        }

        .toast-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
            z-index: 999;
            opacity: 0;
            transition: opacity 0.3s ease;
            pointer-events: none;
        }

        .toast-overlay.show {
            opacity: 1;
            pointer-events: auto;
        }

        .toast-icon {
            font-size: 56px;
            margin-bottom: 16px;
            animation: bounce 0.6s ease;
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        .toast-message {
            font-size: 18px;
            font-weight: 800;
            color: #1f2937;
            margin-bottom: 8px;
        }

        .toast-submessage {
            font-size: 14px;
            color: #6b7280;
            line-height: 1.4;
        }

        .toast-button {
            margin-top: 20px;
            width: 100%;
            padding: 12px;
            background: #6366f1;
            color: white;
            border: none;
            border-radius: 12px;
            font-weight: 700;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .toast-button:active {
            transform: scale(0.95);
        }
    </style>
</head>
<body>
    <div class="mobile-container">
        <section id="scr-result" class="screen active pt-8 px-5 pb-24">
            <h2 class="text-2xl font-black mb-1 tracking-tight">Your <span class="text-indigo-600">Soul Route</span></h2>
            <p class="text-xs text-gray-400 mb-6">Explore your personalized K-Journey.</p>
            
            <div id="day-tabs-container" class="flex gap-2 overflow-x-auto mb-4 pb-2 scrollbar-hide"></div>

            <div id="result-container" class="space-y-3 min-h-[100px]">
                <div id="loading-spinner" class="loader mx-auto mt-10"></div>
                <p id="loading-text" class="text-center text-gray-400 text-xs mt-2">AI is designing your trip...</p>
            </div>

            <div id="map-container" class="mt-6 w-full h-64 bg-gray-100 rounded-2xl overflow-hidden relative border border-gray-200 shadow-sm"></div>
            
            <div class="mt-6 flex gap-3">
                <button onclick="saveRoute()" class="flex-1 bg-white text-rose-500 border border-rose-100 py-3 rounded-xl font-bold shadow-sm active:scale-95 transition-transform text-sm flex items-center justify-center gap-1">
                    <i class="fa-solid fa-heart"></i> Save
                </button>

                <button onclick="startNewTrip()" class="flex-1 bg-slate-900 text-white py-3 rounded-xl font-bold shadow-lg active:scale-95 transition-transform text-sm">
                    <i class="fa-solid fa-paper-plane"></i> New Trip
                </button>
            </div>
        </section>

        <nav class="bottom-nav">
            <a href="/" class="nav-item"><i class="fa-solid fa-house"></i><span>Home</span></a>
            <a href="/chat.html" class="nav-item active-tab"><i class="fa-solid fa-comment-dots"></i><span>Chat</span></a>
            <a href="/saved.html" class="nav-item"><i class="fa-solid fa-heart"></i><span>Saved</span></a>
            <a href="/photo.html" class="nav-item"><i class="fa-solid fa-book-open"></i><span>Log</span></a>
        </nav>
    </div>

    <script src="script.js"></script>
    
    <script>
        let allSpotsData = []; 

        // [ë³€ê²½ë¨] 1. ì„œë²„ì—ì„œ í‚¤ë¥¼ ë°›ì•„ì™€ì„œ ì§€ë„ë¥¼ ë¡œë“œí•˜ëŠ” í•¨ìˆ˜
        async function loadMapsAndStart() {
            try {
                // (1) ì„œë²„ì—ì„œ API í‚¤ ê°€ì ¸ì˜¤ê¸°
                const response = await fetch('/api/config');
                const config = await response.json();
                const GOOGLE_MAPS_KEY = config.googleMapsKey;

                // (2) êµ¬ê¸€ ë§µ ë¡œë” ì‹¤í–‰ (ë°›ì•„ì˜¨ í‚¤ ì‚¬ìš©)
                ((g)=>{var h,a,k,p="The Google Maps JavaScript API",c="google",l="importLibrary",q="__ib__",m=document,b=window;b=b[c]||(b[c]={});var d=b.maps||(b.maps={}),r=new Set,e=new URLSearchParams,u=()=>h||(h=new Promise(async(f,n)=>{await(a=m.createElement("script"));e.set("libraries",[...r]+"");for(k in g)e.set(k.replace(/[A-Z]/g,t=>"_"+t[0].toLowerCase()),g[k]);e.set("callback",c+".maps."+q);a.src=`https://maps.${c}apis.com/maps/api/js?`+e;d[q]=f;a.onerror=()=>h=n(Error(p+" could not load."));a.nonce=m.querySelector("script[nonce]")?.nonce||"";m.head.append(a)}));d[l]?console.warn(p+" only loads once. Ignoring:",g):(d[l]=(f,...n)=>r.add(f)&&u().then(()=>d[l](f,...n)))})({ 
                    key: GOOGLE_MAPS_KEY, 
                    v: "weekly", 
                    language: "en" 
                });

                // (3) í‚¤ ë¡œë”© í›„ ì•± ë¡œì§ ì‹¤í–‰
                await initializeAppLogic();

            } catch (e) {
                console.error("Critical Error: Failed to load Maps API key.", e);
            }
        }

        // [ë³€ê²½ë¨] 2. ê¸°ì¡´ window.load ë‚´ë¶€ ë¡œì§ì„ í•¨ìˆ˜ë¡œ ë¶„ë¦¬
        async function initializeAppLogic() {
            await initMap(); // script.jsì— ìˆëŠ” í•¨ìˆ˜ ì‹¤í–‰

            // ê¸°ì¡´ ë¡œì§: ì €ì¥ëœ ë°ì´í„° í™•ì¸ ë° ë Œë”ë§
            const existingPlan = localStorage.getItem('currentSpots');
            const surveyData = JSON.parse(localStorage.getItem('surveyData'));

            if (existingPlan) {
                console.log("âœ… ì €ì¥ëœ í”Œëœ ë¡œë“œ");
                processAndRender(JSON.parse(existingPlan));
            } else if (surveyData) {
                console.log("ğŸš€ AI ì¶”ì²œ ìš”ì²­");
                try {
                    const response = await fetch("/api/recommend", { 
                        method: "POST", 
                        headers: { "Content-Type": "application/json" }, 
                        body: JSON.stringify(surveyData) 
                    });
                    const data = await response.json();
                    
                    if (data.spots) {
                        localStorage.setItem('currentSpots', JSON.stringify(data.spots));
                        processAndRender(data.spots);
                    }
                } catch (error) {
                    console.error(error);
                    document.getElementById('result-container').innerHTML = "<p class='text-center text-red-500'>Error.</p>";
                }
            } else {
                // ë°ì´í„°ê°€ ì—†ìœ¼ë©´ ì„¤ë¬¸ì¡°ì‚¬ í˜ì´ì§€ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸
                location.href = 'survey.html';
            }
        }

        // [í•µì‹¬] í˜ì´ì§€ê°€ ë¡œë“œë˜ë©´ ìœ„ í•¨ìˆ˜ ì‹¤í–‰
        window.addEventListener('load', loadMapsAndStart);


        // --- ì•„ë˜ë¶€í„°ëŠ” ê¸°ì¡´ í•¨ìˆ˜ë“¤ (ê±´ë“œë¦¬ì§€ ì•ŠìŒ) ---

        // ë°ì´í„°ë¥¼ ë°›ì•„ì„œ Dayë¥¼ ê³„ì‚°í•˜ê³  í™”ë©´ì— ë¿Œë¦¬ê¸°
        function processAndRender(spots) {
            const spotsPerDay = 5; 
            
            // ë°ì´í„°ì— 'day' ì†ì„±ì´ ì—†ìœ¼ë©´ ìš°ë¦¬ê°€ ì£¼ì…!
            allSpotsData = spots.map((spot, index) => {
                if (!spot.day) {
                    spot.day = Math.floor(index / spotsPerDay) + 1;
                }
                return spot;
            });

            // ë¡œë”© ë„ê¸°
            document.getElementById('loading-spinner').style.display = 'none';
            document.getElementById('loading-text').style.display = 'none';
            
            // íƒ­ ë§Œë“¤ê³  ì²« ë²ˆì§¸ ë‚  ë³´ì—¬ì£¼ê¸°
            createDayTabs();
            renderDay(1);
        }

        // íƒ­ ìƒì„± í•¨ìˆ˜
        function createDayTabs() {
            const container = document.getElementById('day-tabs-container');
            container.innerHTML = ''; 
            
            const maxDay = Math.max(...allSpotsData.map(s => s.day));

            for (let i = 1; i <= maxDay; i++) {
                const btn = document.createElement('button');
                btn.className = `day-tab ${i === 1 ? 'active' : ''}`;
                btn.innerText = `Day ${i}`;
                btn.onclick = () => renderDay(i);
                container.appendChild(btn);
            }
        }

        // íŠ¹ì • ë‚ ì§œë§Œ ë³´ì—¬ì£¼ê¸°
        function renderDay(day) {
            document.querySelectorAll('.day-tab').forEach(btn => {
                btn.classList.toggle('active', btn.innerText === `Day ${day}`);
            });

            const dailySpots = allSpotsData.filter(s => s.day === day);
            
            // script.jsì— ìˆëŠ” í•¨ìˆ˜ë“¤ í˜¸ì¶œ
            if (typeof renderResult === 'function') renderResult(dailySpots); 
            if (typeof drawRouteOnMap === 'function') drawRouteOnMap(dailySpots);
        }

        async function saveRoute() {
            if (!allSpotsData || allSpotsData.length === 0) {
                alert("ì €ì¥í•  ê²½ë¡œê°€ ì—†ìŠµë‹ˆë‹¤.");
                return;
            }

            // ---------------------------------------------------------
            // [1] Azure Blob Storage & DB ì¹´ìš´íŠ¸ ì¦ê°€ (í´ë¼ìš°ë“œ ì €ì¥)
            // ---------------------------------------------------------
            try {
                // (1) Azureì— ì „ì²´ ê²½ë¡œ íŒŒì¼ ì €ì¥
                const planData = {
                    timestamp: new Date().toISOString(),
                    spots: allSpotsData,
                    survey: JSON.parse(localStorage.getItem('surveyData') || '{}')
                };

                fetch('/api/save-plan', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(planData)
                }).then(res => res.json()).then(data => {
                    if(data.success) console.log("âœ… Azure Blob ì €ì¥ ì™„ë£Œ");
                });

                // (2) DBì— ë°©ë¬¸ ì¹´ìš´íŠ¸ ì¦ê°€
                console.log("ğŸ”¥ ì¸ê¸°ë„ ë°˜ì˜ ì‹œì‘...");
                for (const spot of allSpotsData) {
                    const formData = new FormData();
                    formData.append('place_name', spot.name); 
                    fetch('/api/upload-and-count', { method: 'POST', body: formData });
                }

            } catch (e) {
                console.error("âŒ í´ë¼ìš°ë“œ ì €ì¥ ì¤‘ ì˜¤ë¥˜:", e);
                // í´ë¼ìš°ë“œ ì˜¤ë¥˜ê°€ ë‚˜ë„ ë¡œì»¬ ì €ì¥ì€ ì§„í–‰ë˜ë„ë¡ ë¹„ë™ê¸° ì²˜ë¦¬
            }

            // ---------------------------------------------------------
            // [2] ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ ì €ì¥ (Saved íƒ­ìš© - ì—¬ê¸°ê°€ í•µì‹¬ ìˆ˜ì •!)
            // ---------------------------------------------------------
            const currentPlan = {
                id: Date.now(),
                date: new Date().toLocaleDateString(),
                spots: allSpotsData
            };
            
            // saved.htmlì—ì„œ ì“°ëŠ” í‚¤ ì´ë¦„ì¸ 'ktrip_saved_routes'ë¡œ ë§ì¶°ì¤ë‹ˆë‹¤.
            let savedPlans = JSON.parse(localStorage.getItem('ktrip_saved_routes')) || [];
            savedPlans.push(currentPlan);
            localStorage.setItem('ktrip_saved_routes', JSON.stringify(savedPlans));

            
        }
        // Toast ì•Œë¦¼ í‘œì‹œ í•¨ìˆ˜
        function showToast(message, submessage = '', icon = 'ğŸ’š', showButton = false, buttonText = 'í™•ì¸', buttonCallback = null) {
            // ì˜¤ë²„ë ˆì´ ìƒì„±
            const overlay = document.createElement('div');
            overlay.className = 'toast-overlay';
            
            // Toast ìƒì„±
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.innerHTML = `
                <div class="toast-icon">${icon}</div>
                <div class="toast-message">${message}</div>
                ${submessage ? `<div class="toast-submessage">${submessage}</div>` : ''}
                ${showButton ? `<button class="toast-button" id="toast-btn">${buttonText}</button>` : ''}
            `;
            
            document.body.appendChild(overlay);
            document.body.appendChild(toast);
            
            // ì• ë‹ˆë©”ì´ì…˜ ì ìš©
            setTimeout(() => {
                overlay.classList.add('show');
                toast.classList.add('show');
            }, 10);
            
            // ë‹«ê¸° í•¨ìˆ˜
            const closeToast = () => {
                overlay.classList.remove('show');
                toast.classList.remove('show');
                setTimeout(() => {
                    overlay.remove();
                    toast.remove();
                }, 300);
            };
            
            // ë²„íŠ¼ì´ ìˆìœ¼ë©´ ë²„íŠ¼ í´ë¦­ ì‹œ ë‹«ê¸°
            if (showButton) {
                document.getElementById('toast-btn').onclick = () => {
                    closeToast();
                    if (buttonCallback) buttonCallback();
                };
            } else {
                // ë²„íŠ¼ì´ ì—†ìœ¼ë©´ 2ì´ˆ í›„ ìë™ìœ¼ë¡œ ë‹«ê¸°
                setTimeout(closeToast, 2000);
            }
            
            // ì˜¤ë²„ë ˆì´ í´ë¦­ ì‹œ ë‹«ê¸°
            overlay.onclick = closeToast;
        }

        // saveRoute í•¨ìˆ˜ ìˆ˜ì • (ê¸°ì¡´ script.jsì˜ í•¨ìˆ˜ë¥¼ ì˜¤ë²„ë¼ì´ë“œ)
        function saveRoute() {
            const STORAGE_KEY = 'ktrip_saved_routes';
            const currentSpots = JSON.parse(localStorage.getItem('currentSpots'));
            
            if (!currentSpots || currentSpots.length === 0) {
                showToast('No Route to Save', 'Please generate a route first', 'âš ï¸', true, 'í™•ì¸');
                return;
            }
            
            const savedData = JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
            const newTrip = {
                id: Date.now(),
                date: new Date().toISOString().split('T')[0],
                spots: currentSpots
            };
            
            savedData.push(newTrip);
            localStorage.setItem(STORAGE_KEY, JSON.stringify(savedData));
            
            // ì˜ˆìœ toast íŒì—… í‘œì‹œ
            showToast(
                'Trip Saved Successfully!', 
                'Check your saved trips anytime', 
                'ğŸ’š',
                true,
                'í™•ì¸'
            );
        }

        function startNewTrip() {
            // 1. ê³¼ê±°ì˜ ëª¨ë“  ê¸°ì–µ ì‚­ì œ
            localStorage.removeItem('currentSpots');
            localStorage.removeItem('surveyData');
            
            // 2. ì„¤ë¬¸ì¡°ì‚¬ í˜ì´ì§€ë¡œ ì´ë™
            location.href = '/survey.html'; // ê²½ë¡œ ìˆ˜ì • (ì„œë²„ ì„¤ì •ì— ë”°ë¼ /survey ë˜ëŠ” survey.html)
        }
    </script>
</body>
</html>
