<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
    <title>K-Trip | Result</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="style.css">
    <style>
        /* Day íƒ­ ë””ìì¸ */
        .day-tab {
            padding: 8px 16px; border-radius: 20px; font-size: 13px; font-weight: 700;
            background-color: white; color: #6b7280; border: 1px solid #e5e7eb;
            cursor: pointer; transition: all 0.2s; white-space: nowrap;
        }
        .day-tab.active {
            background-color: #6366f1; color: white; border-color: #6366f1;
            box-shadow: 0 4px 6px -1px rgba(99, 102, 241, 0.3);
        }
        /* ìŠ¤í¬ë¡¤ë°” ìˆ¨ê¸°ê¸° */
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body>
    <div class="mobile-container">
        <section id="scr-result" class="screen active pt-8 px-5 pb-24">
            <h2 class="text-2xl font-black mb-1 tracking-tight">Your <span class="text-indigo-600">Soul Route</span></h2>
            <p class="text-xs text-gray-400 mb-6">Explore your personalized K-Journey.</p>
            
            <div id="day-tabs-container" class="flex gap-2 overflow-x-auto mb-4 pb-2 scrollbar-hide"></div>

            <div id="result-container" class="space-y-3 min-h-[100px]">
                <div id="loading-spinner" class="loader mx-auto mt-10"></div>
                <p id="loading-text" class="text-center text-gray-400 text-xs mt-2">AI is designing your trip...</p>
            </div>

            <div id="map-container" class="mt-6 w-full h-64 bg-gray-100 rounded-2xl overflow-hidden relative border border-gray-200 shadow-sm"></div>
            
            <div class="mt-6 flex gap-3">
    <button onclick="saveRoute()" class="flex-1 bg-white text-rose-500 border border-rose-100 py-3 rounded-xl font-bold shadow-sm active:scale-95 transition-transform text-sm flex items-center justify-center gap-1">
        <i class="fa-solid fa-heart"></i> Save
    </button>

    <button onclick="startNewTrip()" class="flex-1 bg-slate-900 text-white py-3 rounded-xl font-bold shadow-lg active:scale-95 transition-transform text-sm">
        New Trip
    </button>
</div>
        </section>

        <nav class="bottom-nav">
            <a href="/" class="nav-item"><i class="fa-solid fa-house"></i><span>Home</span></a>
            <a href="/chat.html" class="nav-item active-tab"><i class="fa-solid fa-comment-dots"></i><span>Chat</span></a>
            <a href="/saved.html" class="nav-item"><i class="fa-solid fa-heart"></i><span>Saved</span></a>
            <a href="/photo.html" class="nav-item"><i class="fa-solid fa-book-open"></i>
    <span>Log</span>
</a>
        </nav>
    </div>

    <script>
        ((g)=>{var h,a,k,p="The Google Maps JavaScript API",c="google",l="importLibrary",q="__ib__",m=document,b=window;b=b[c]||(b[c]={});var d=b.maps||(b.maps={}),r=new Set,e=new URLSearchParams,u=()=>h||(h=new Promise(async(f,n)=>{await(a=m.createElement("script"));e.set("libraries",[...r]+"");for(k in g)e.set(k.replace(/[A-Z]/g,t=>"_"+t[0].toLowerCase()),g[k]);e.set("callback",c+".maps."+q);a.src=`https://maps.${c}apis.com/maps/api/js?`+e;d[q]=f;a.onerror=()=>h=n(Error(p+" could not load."));a.nonce=m.querySelector("script[nonce]")?.nonce||"";m.head.append(a)}));d[l]?console.warn(p+" only loads once. Ignoring:",g):(d[l]=(f,...n)=>r.add(f)&&u().then(()=>d[l](f,...n)))})({ key: "AIzaSyCupkJq4a5oOMYWbPE630TcPuQq9dex4vw", v: "weekly", language: "en" });
    </script>
    <script src="script.js"></script>
    
    <script>
        // 1. ì„œë²„ì—ì„œ API í‚¤ë¥¼ ë¨¼ì € ê°€ì ¸ì˜µë‹ˆë‹¤.
        async function startWithConfig() {
            try {
                const response = await fetch('/api/config');
                const config = await response.json();
                const GOOGLE_MAPS_KEY = config.googleMapsKey;

                // 2. ë°›ì•„ì˜¨ í‚¤ë¥¼ ì‚¬ìš©í•˜ì—¬ êµ¬ê¸€ ë§µ ë¡œë” ì‹¤í–‰
                ((g)=>{var h,a,k,p="The Google Maps JavaScript API",c="google",l="importLibrary",q="__ib__",m=document,b=window;b=b[c]||(b[c]={});var d=b.maps||(b.maps={}),r=new Set,e=new URLSearchParams,u=()=>h||(h=new Promise(async(f,n)=>{await(a=m.createElement("script"));e.set("libraries",[...r]+"");for(k in g)e.set(k.replace(/[A-Z]/g,t=>"_"+t[0].toLowerCase()),g[k]);e.set("callback",c+".maps."+q);a.src=`https://maps.${c}apis.com/maps/api/js?`+e;d[q]=f;a.onerror=()=>h=n(Error(p+" could not load."));a.nonce=m.querySelector("script[nonce]")?.nonce||"";m.head.append(a)}));d[l]?console.warn(p+" only loads once. Ignoring:",g):(d[l]=(f,...n)=>r.add(f)&&u().then(()=>d[l](f,...n)))})({ 
                    key: GOOGLE_MAPS_KEY, 
                    v: "weekly", 
                    language: "en" 
                });

                // 3. í‚¤ ë¡œë”©ì´ ì™„ë£Œëœ í›„, ê¸°ì¡´ì˜ ë©”ì¸ ë¡œì§ ì‹¤í–‰
                initializeApp();

            } catch (error) {
                console.error("API í‚¤ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", error);
            }
        }

        // ì‹¤í–‰
        startWithConfig();
    </script>

    <script src="script.js"></script>
    
    <script>
        let allSpotsData = []; 

        // ê¸°ì¡´ window 'load' ì´ë²¤íŠ¸ë¥¼ í•¨ìˆ˜ë¡œ ë¶„ë¦¬í•˜ì—¬ í‚¤ ë¡œë“œ í›„ì— ì‹¤í–‰ë˜ë„ë¡ í•¨
        async function initializeApp() {
            await initMap();

            // 1. ì €ì¥ëœ ë°ì´í„° í™•ì¸
            const existingPlan = localStorage.getItem('currentSpots');
            const surveyData = JSON.parse(localStorage.getItem('surveyData'));

            if (existingPlan) {
                console.log("âœ… ì €ì¥ëœ í”Œëœ ë¡œë“œ");
                processAndRender(JSON.parse(existingPlan));
            } else if (surveyData) {
                console.log("ğŸš€ AI ì¶”ì²œ ìš”ì²­");
                try {
                    const response = await fetch("/api/recommend", { 
                        method: "POST", 
                        headers: { "Content-Type": "application/json" }, 
                        body: JSON.stringify(surveyData) 
                    });
                    const data = await response.json();
                    
                    if (data.spots) {
                        localStorage.setItem('currentSpots', JSON.stringify(data.spots));
                        processAndRender(data.spots);
                    }
                } catch (error) {
                    console.error(error);
                    document.getElementById('result-container').innerHTML = "<p class='text-center text-red-500'>Error.</p>";
                }
            } else {
                location.href = 'survey.html';
            }
        }

        // --- ì•„ë˜ processAndRender ë“± ê¸°ì¡´ í•¨ìˆ˜ë“¤ì€ ë™ì¼í•˜ë¯€ë¡œ ìƒëµ (ê·¸ëŒ€ë¡œ ë‘ì‹œë©´ ë©ë‹ˆë‹¤) ---
        function processAndRender(spots) {
            const spotsPerDay = 5; 
            allSpotsData = spots.map((spot, index) => {
                if (!spot.day) {
                    spot.day = Math.floor(index / spotsPerDay) + 1;
                }
                return spot;
            });
            document.getElementById('loading-spinner').style.display = 'none';
            document.getElementById('loading-text').style.display = 'none';
            createDayTabs();
            renderDay(1);
        }

        function createDayTabs() {
            const container = document.getElementById('day-tabs-container');
            container.innerHTML = ''; 
            const maxDay = Math.max(...allSpotsData.map(s => s.day));
            for (let i = 1; i <= maxDay; i++) {
                const btn = document.createElement('button');
                btn.className = `day-tab ${i === 1 ? 'active' : ''}`;
                btn.innerText = `Day ${i}`;
                btn.onclick = () => renderDay(i);
                container.appendChild(btn);
            }
        }

        function renderDay(day) {
            document.querySelectorAll('.day-tab').forEach(btn => {
                btn.classList.toggle('active', btn.innerText === `Day ${day}`);
            });
            const dailySpots = allSpotsData.filter(s => s.day === day);
            renderResult(dailySpots); 
            drawRouteOnMap(dailySpots);
        }

        function startNewTrip() {
            localStorage.removeItem('currentSpots');
            localStorage.removeItem('surveyData');
            location.href = '/survey'; 
        }
    </script> 
}
    </script>
</body>